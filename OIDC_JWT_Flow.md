# OIDC \ubc0f JWT \ud1a0\ud070 \ubc1c\uae09 \ubc0f \uac80\uc99d \ud50c\ub85c\uc6b0 (\ud559\uc2b5\uc6a9)

## \uac1c\uc694

\uc774 \ubb38\uc11c\ub294 OIDC(OpenID Connect)\ub97c \uc0ac\uc6a9\ud558\uc5ec \uc0ac\uc6a9\uc790\ub97c \uc778\uc99d\ud558\uace0, \uc774\ub97c \ud1a0\ub300\ub85c \uc6b0\ub9ac \uc560\ud50c\ub9ac\ucf00\uc774\uc158\uc758 \uc790\uccb4 JWT(JSON Web Token)\ub97c \ubc1c\uae09\ud558\uace0 \uac80\uc99d\ud558\ub294 \uc804\uccb4 \uacfc\uc815\uc744 \uc124\uba85\ud569\ub2c8\ub2e4. \ud559\uc2b5\uc790\uac00 \uc27d\uac8c \uc774\ud574\ud560 \uc218 \uc788\ub3c4\ub85d \uac01 \ub2e8\uacc4\ub97c \ucd5c\ub300\ud55c \uac04\ub2e8\ud558\uace0 \uba85\ub8cc\ud558\uac8c \uc124\uacc4\ub418\uc5c8\uc2b5\ub2c8\ub2e4.

---

## \uc804\uccb4 \ud50c\ub85c\uc6b0 \uc694\uc57d

| \ub2e8\uacc4 | \uc218\ud589 \uc8fc\uccb4 | \uc124\uba85 |
| --- | --- | --- |
| 1 | \ud074\ub77c\uc774\uc5b8\ud2b8 (\ube0c\ub77c\uc6b0\uc800) | \uc0ac\uc6a9\uc790\uac00 \ub85c\uadf8\uc778 \ubc84\ud2bc\uc744 \ud074\ub9ad\ud558\uba74, OIDC Provider(\uc608: Kakao)\uc758 \ub85c\uadf8\uc778 \ud398\uc774\uc9c0\ub85c \ub9ac\ub2e4\uc774\ub809\ud2b8 \ub429\ub2c8\ub2e4. |
| 2 | \uc0ac\uc6a9\uc790 | OIDC Provider\uc5d0\uc11c ID\uc640 \ube44\ubc00\ubc88\ud638\ub97c \uc785\ub825\ud558\uc5ec \ub85c\uadf8\uc778\ud569\ub2c8\ub2e4. |
| 3 | OIDC Provider | \ub85c\uadf8\uc778\uc774 \uc131\uacf5\ud558\uba74, \uc9c0\uc815\ub41c Redirect URI\ub85c **Authorization Code**\ub97c \ub2f4\uc544 \ubcf4\ub0c5\ub2c8\ub2e4. |
| 4 | \ud074\ub77c\uc774\uc5b8\ud2b8 | Authorization Code\ub97c \uac00\uc9c0\uace0 \ubc31\uc5d4\ub4dc \uc11c버\uc5d0 **ID Token**\uc744 \uc694\uccad\ud569\ub2c8\ub2e4. |
| 5 | \ubc31\uc5d4\ub4dc \uc11c버 | OIDC Provider\ub85c\ubd80\ud130 \ubc1b\uc740 ID Token\uc758 \uc720\ud6a8\uc131\uc744 \uac80\uc99d\ud569\ub2c8\ub2e4. (JWK \uc0ac\uc6a9) |
| 6 | \ubc31\uc5d4\ub4dc \uc11c버 | ID Token\uc774 \uc720\ud6a8\ud558\uba74, Token\uc5d0 \ub4e4\uc5b4\uc788\ub294 \uc0ac\uc6a9\uc790 \uc815\ubcf4\ub97c \ud655\uc778\ud558\uace0 DB\uc5d0 \uc800\uc7a5\ud569\ub2c8\ub2e4. (\ud544\uc694\uc2dc \ud68c\uc6d1\uac00\uc785) |
| 7 | \ubc31\uc5d4\ub4dc \uc11c버 | \uc0ac\uc6a9\uc790 \uc815\ubcf4\ub97c \ub2f4\uc740 **\uc790\uccb4 JWT**\ub97c \uc0dd\uc131\ud558\uc5ec \ud074\ub77c\uc774\uc5b8\ud2b8\uc5d0\uac8c \uc804\ub2ec\ud569\ub2c8\ub2e4. |
| 8 | \ud074\ub77c\uc774\uc5b8\ud2b8 | \uc774\ud6c4 API \uc694\uccad \uc2dc `Authorization` \ud5e4\ub354\uc5d0 \uc790\uccb4 JWT\ub97c \ud3ec\ud568\ud558\uc5ec \ubcf4\냅\ub2c8\ub2e4. |
| 9 | \ubc31\uc5d4\ub4dc \uc11c버 | API \uc694\uccad\uc744 \ubc1b\uc744 \ub54c\ub9c8\ub2e4 JWT\uc758 \uc720\ud6a8\uc131\uc744 \uac80\uc99d\ud558\uace0, \uc778\uc99d\ub41c \uc0ac\uc6a9\uc790\uc758 \uc694\uccad\uc744 \ucc98\ub9ac\ud569\ub2c8\ub2e4. |

---

## \uc790\uccb4 JWT \uc0dd\uc131 \ubc0f \uac80\uc99d (`JwtUtil.java`)

OIDC \uc778\uc99d\uc774 \uc644\ub8cc\ub418\uba74, \uc6b0\ub9ac \uc11c버\uc2a4\ub294 \ud074\ub77c\uc774\uc5b8\ud2b8\uc640\uc758 \ud1b5\uc2e0\uc744 \uc704\ud574 \uc790\uccb4 JWT\ub97c \uc0dd\uc131\ud569\ub2c8\ub2e4. \uc774 JWT\ub294 \uc0ac\uc6a9\uc790\ub97c \uc2dd\ubcc4\ud558\uace0 \uc778\uc99d\ud558\ub294 \ub370 \uc0ac\uc6a9\ub429\ub2c8\ub2e4.

`JwtUtil.java`\ub294 Nimbus(nimbus-jose-jwt) \ub77c\uc774\ube0c\ub7ec\ub9ac\ub97c \uc0ac\uc6a9\ud558\uc5ec JWT\ub97c \uc554\ud638\ud654\uc801\uc73c\ub85c \uc548\uc804\ud558\uac8c \ucc98\ub9ac\ud569\ub2c8\ub2e4.

### JWT \uc0dd\uc131 (`create` \uba54\uc11c\ub4dc)

```java
// 1. JWS Signer \uc0dd\uc131: HMAC \uc54c\uace0\ub9ac\uc998\uacfc \uc26c\ud06c\ub9bf \ud0a4\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4.
JWSSigner signer = new MACSigner(SECRET);

// 2. JWT Claims \uc124\uc815: \ud1a0\ud070\uc5d0 \ub2f4\uc744 \uc815\ubcf4\ub97c \uc124\uc815\ud569\ub2c8\ub2e4.
JWTClaimsSet claimsSet = new JWTClaimsSet.Builder()
        .subject("user-token") // \ud1a0\ud070 \uc81c목
        .issueTime(new Date()) // \ubc1c\uae09 \uc2dc\uac04
        .expirationTime(new Date(System.currentTimeMillis() + 1000 * 60 * 60)) // \ub9cc\ub8cc \uc2dc\uac04 (1\uc2dc\uac04)
        .claim("id", user.getId()) // \ube44\uacf5\uac1c \ud074\ub808\uc784: \uc0ac\uc6a9\uc790 ID
        .claim("username", user.getUsername()) // \ube44\uacf5\uac1c \ud074\ub808\uc784: \uc0ac\uc6a9\uc790 \uc774\ub984
        .build();

// 3. JWS \uac1d\uccb4 \uc0dd\uc131: \ud5e4\ub354\uc640 Claims\ub97c \uacb0\ud569\ud569\ub2c8\ub2e4.
SignedJWT signedJWT = new SignedJWT(new JWSHeader(JWSAlgorithm.HS256), claimsSet);

// 4. JWT \uc11c\uba85: Signer\ub97c \uc774\uc6a9\ud558\uc5ec JWT\uc5d0 \uc11c\uba85\ud569\ub2c8\ub2e4.
signedJWT.sign(signer);

// 5. JWT \uc9c1\ub82c\ud654: \uc0dd\uc131\ub41c JWT\ub97c \ubb38\uc790\uc5f4\ub85c \ubcc0\ud658\ud569\ub2c8\ub2e4.
return signedJWT.serialize();
```

### JWT \uac80\uc99d (`verify` \uba54\uc11c\ub4dc)

```java
// 1. JWT \ud30c\uc2f1: \ubb38\uc790\uc5f4\ub85c\ub41c JWT\ub97c SignedJWT \uac1d\uccb4\ub85c \ubcc0\ud658\ud569\ub2c8\ub2e4.
SignedJWT signedJWT = SignedJWT.parse(jwt);

// 2. JWS Verifier \uc0dd\uc131: HMAC \uc54c\uace0\ub9ac\uc998\uacfc \uc26c\ud06c\ub9bf \ud0a4\ub97c \uc0ac\uc6a9\ud569\ub2c8\ub2e4.
JWSVerifier verifier = new MACVerifier(SECRET);

// 3. JWT \uc11c\uba85 \uac80\uc99d: Verifier\ub97c \uc774\uc6a9\ud558\uc5ec \uc11c\uba85\uc774 \uc720\ud6a8\ud55c\uc9c0 \ud655\uc778\ud569\ub2c8\ub2e4.
if (!signedJWT.verify(verifier)) {
    throw new RuntimeException("JWT \uc11c\uba85\uc774 \uc720\ud6a8\ud558\uc9c0 \uc54a\uc2b5\ub2c8\ub2e4.");
}

// 4. JWT Claims \uac80\uc99d: \ud1a0\ud070\uc5d0 \ub2f4\uae34 \uc815\ubcf4\ub97c \uac80\uc99d\ud569\ub2c8\ub2e4.
JWTClaimsSet claimsSet = signedJWT.getJWTClaimsSet();

// 5. \ub9cc\ub8cc \uc2dc\uac04 \uac80\uc99d: \ud604\uc7ac \uc2dc\uac04\uc774 \ub9cc\ub8cc \uc2dc\uac04\uc744 \uc9c0\ub0ac\ub294\uc9c0 \ud655\uc778\ud569\ub2c8\ub2e4.
if (new Date().after(claimsSet.getExpirationTime())) {
    throw new RuntimeException("JWT\uac00 \ub9cc\ub8cc\ub418\uc5c8\uc2b5\ub2c8\ub2e4.");
}

// 6. Claims\uc5d0\uc11c \uc0ac\uc6a9\uc790 \uc815\ubcf4 \ucd94\ucd9c
Long id = claimsSet.getLongClaim("id");
String username = claimsSet.getStringClaim("username");

// 7. \uc0ac\uc6a9\uc790 \uac1d\uccb4 \uc0dd\uc131 \ubc0f \ubc18\ud658
return User.builder()
        .id(id.intValue())
        .username(username)
        .build();
```
